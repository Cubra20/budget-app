<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Budget App</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body class="bg-gray-100 p-4">

<div class="flex justify-between items-center mb-4">
  <h1 class="text-2xl font-bold">Budget Dashboard</h1>
  <div class="flex gap-2">
    <span id="role" class="text-sm text-gray-500"></span>
    <button onclick="toggleTheme()" class="px-2">üåôMODE</button>
  </div>
</div>

<!-- FORM -->
<div class="bg-white p-4 rounded shadow mb-4">
  <div class="grid grid-cols-2 gap-2">
    <input id="date" type="date" class="border p-1">
    <input id="category" placeholder="Category" class="border p-1">
    <input id="desc" placeholder="Description" class="border p-1 col-span-2">
    <input id="amount" type="number" placeholder="Amount" class="border p-1">
    <select id="type" class="border p-1">
      <option>Income</option>
      <option>Expense</option>
    </select>
  </div>
  <button onclick="add()" class="mt-2 bg-green-500 text-white px-3 py-1 rounded">Save</button>
</div>

<!-- TABLE -->
<div class="bg-white p-4 rounded shadow mb-4">
  <table class="w-full text-sm">
    <thead><tr class="text-left"><th>Cat</th><th>Amt</th><th></th></tr></thead>
    <tbody id="list"></tbody>
  </table>
</div>

<!-- CHARTS -->
<div class="grid md:grid-cols-2 gap-4">
  <canvas id="catChart"></canvas>
  <canvas id="monthChart"></canvas>
</div>

<!-- EXPORT -->
<div class="mt-4 flex gap-2 admin-only">
  <button onclick="pdf()" class="bg-red-500 text-white px-3 py-1 rounded">PDF</button>
  <button onclick="excel()" class="bg-green-600 text-white px-3 py-1 rounded">Excel</button>
</div>

<!-- EDIT MODAL -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
  <div class="bg-white p-4 rounded w-80">
    <input id="eid" hidden>
    <input id="edate" type="date" class="border p-1 w-full mb-1">
    <input id="ecat" class="border p-1 w-full mb-1">
    <input id="edesc" class="border p-1 w-full mb-1">
    <input id="eamt" type="number" class="border p-1 w-full mb-1">
    <select id="etype" class="border p-1 w-full mb-2">
      <option>Income</option>
      <option>Expense</option>
    </select>
    <button onclick="update()" class="bg-green-500 text-white w-full">Update</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyVSBcFx68gzPWg0UzaErjWuz7fYvJAZdyDsfpnRlm70j-5mnorb7jFk6QtLqBlUhKZdg/exec";
let allData = [];
let user;

fetch(API+"?action=user",{method:"POST"}).then(r=>r.json()).then(u=>{
  user=u;
  role.innerText=u.role;
  if(u.role!=="Admin"){
    document.querySelectorAll(".admin-only").forEach(e=>e.remove());
  }
});

function add(){
  fetch(API+"?action=add",{method:"POST",body:JSON.stringify({
    date:date.value, category:category.value, description:desc.value,
    amount:amount.value, type:type.value
  })}).then(load);
}

function load(){
  fetch(API+"?action=list",{method:"POST"}).then(r=>r.json()).then(d=>{
    allData=d;
    list.innerHTML=d.map(r=>`
      <tr>
        <td>${r[2]}</td>
        <td>${r[4]}</td>
        <td>
          <button onclick='edit(${JSON.stringify(r)})'>‚úèÔ∏è</button>
          <button onclick="del('${r[0]}')">üóë</button>
        </td>
      </tr>`).join("");
    charts();
  });
}

function edit(r){
  modal.classList.remove("hidden");
  eid.value=r[0]; edate.value=r[1].split("T")[0];
  ecat.value=r[2]; edesc.value=r[3];
  eamt.value=r[4]; etype.value=r[5];
}

function update(){
  fetch(API+"?action=update",{method:"POST",body:JSON.stringify({
    id:eid.value,date:edate.value,category:ecat.value,
    description:edesc.value,amount:eamt.value,type:etype.value
  })}).then(()=>{ modal.classList.add("hidden"); load(); });
}

function del(id){
  fetch(API+"?action=delete",{method:"POST",body:JSON.stringify({id})}).then(load);
}

function charts(){
  const byCat={}, byMonth={};
  allData.forEach(r=>{
    if(r[5]==="Expense"){
      byCat[r[2]]=(byCat[r[2]]||0)+r[4];
      const m=new Date(r[1]).toLocaleString("default",{month:"short"});
      byMonth[m]=(byMonth[m]||0)+r[4];
    }
  });

  new Chart(catChart,{type:"pie",
    data:{labels:Object.keys(byCat),datasets:[{data:Object.values(byCat)}]}
  });

  new Chart(monthChart,{type:"bar",
    data:{labels:Object.keys(byMonth),datasets:[{data:Object.values(byMonth)}]}
  });
}

function pdf(){
  fetch(API+"?action=exportPDF",{method:"POST"})
    .then(r=>r.json()).then(d=>window.open(d.url));
}

function excel(){
  window.open(API+"?action=exportExcel","_blank");
}

function toggleTheme(){
  document.body.classList.toggle("bg-gray-900");
}

load();
</script>
</body>
</html>
