<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Budget App</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>
<h2>Budget App</h2>
<button onclick="toggle()">ğŸŒ™</button>

<div class="card">
<input type="date" id="date">
<input placeholder="Category" id="cat">
<input placeholder="Description" id="desc">
<input type="number" id="amt">
<select id="type">
<option>Income</option>
<option>Expense</option>
</select>
<button onclick="add()">Save</button>
</div>

<!-- EDIT MODAL -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
  <div class="bg-white p-4 rounded w-80">
    <input id="eid" hidden>
    <input id="edate" type="date" class="border p-1 w-full mb-1">
    <input id="ecat" class="border p-1 w-full mb-1">
    <input id="edesc" class="border p-1 w-full mb-1">
    <input id="eamt" type="number" class="border p-1 w-full mb-1">
    <select id="etype" class="border p-1 w-full mb-2">
      <option>Income</option>
      <option>Expense</option>
    </select>
    <button onclick="update()" class="bg-green-500 text-white w-full">Update</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyVSBcFx68gzPWg0UzaErjWuz7fYvJAZdyDsfpnRlm70j-5mnorb7jFk6QtLqBlUhKZdg/exec";
let allData = [];
let user;

fetch(API+"?action=user",{method:"POST"}).then(r=>r.json()).then(u=>{
  user=u;
  role.innerText=u.role;
  if(u.role!=="Admin"){
    document.querySelectorAll(".admin-only").forEach(e=>e.remove());
  }
});

function add(){
  fetch(API+"?action=add",{method:"POST",body:JSON.stringify({
    date:date.value, category:category.value, description:desc.value,
    amount:amount.value, type:type.value
  })}).then(load);
}

function load(){
  fetch(API+"?action=list",{method:"POST"}).then(r=>r.json()).then(d=>{
    allData=d;
    list.innerHTML=d.map(r=>`
      <tr>
        <td>${r[2]}</td>
        <td>${r[4]}</td>
        <td>
          <button onclick='edit(${JSON.stringify(r)})'>âœï¸</button>
          <button onclick="del('${r[0]}')">ğŸ—‘</button>
        </td>
      </tr>`).join("");
    charts();
  });
}

function edit(r){
  modal.classList.remove("hidden");
  eid.value=r[0]; edate.value=r[1].split("T")[0];
  ecat.value=r[2]; edesc.value=r[3];
  eamt.value=r[4]; etype.value=r[5];
}

function update(){
  fetch(API+"?action=update",{method:"POST",body:JSON.stringify({
    id:eid.value,date:edate.value,category:ecat.value,
    description:edesc.value,amount:eamt.value,type:etype.value
  })}).then(()=>{ modal.classList.add("hidden"); load(); });
}

function del(id){
  fetch(API+"?action=delete",{method:"POST",body:JSON.stringify({id})}).then(load);
}

function charts(){
  const byCat={}, byMonth={};
  allData.forEach(r=>{
    if(r[5]==="Expense"){
      byCat[r[2]]=(byCat[r[2]]||0)+r[4];
      const m=new Date(r[1]).toLocaleString("default",{month:"short"});
      byMonth[m]=(byMonth[m]||0)+r[4];
    }
  });

  new Chart(catChart,{type:"pie",
    data:{labels:Object.keys(byCat),datasets:[{data:Object.values(byCat)}]}
  });

  new Chart(monthChart,{type:"bar",
    data:{labels:Object.keys(byMonth),datasets:[{data:Object.values(byMonth)}]}
  });
}

function pdf(){
  fetch(API+"?action=exportPDF",{method:"POST"})
    .then(r=>r.json()).then(d=>window.open(d.url));
}

function excel(){
  window.open(API+"?action=exportExcel","_blank");
}

function toggleTheme(){
  document.body.classList.toggle("bg-gray-900");
}

load();
</script>
</body>
</html>
